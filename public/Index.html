<!DOCTYPE html>
<html lang="ru">
<head>
    <title>Login V4</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'">
    <link rel="icon" type="image/png" href="images/icons/favicon.ico"/>
    <link rel="stylesheet" type="text/css" href="vendor/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="fonts/font-awesome-4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="fonts/iconic/css/material-design-iconic-font.min.css">
    <link rel="stylesheet" type="text/css" href="vendor/animate/animate.css">
    <link rel="stylesheet" type="text/css" href="vendor/css-hamburgers/hamburgers.min.css">
    <link rel="stylesheet" type="text/css" href="vendor/animsition/css/animsition.min.css">
    <link rel="stylesheet" type="text/css" href="vendor/select2/select2.min.css">
    <link rel="stylesheet" type="text/css" href="vendor/daterangepicker/daterangepicker.css">
    <link rel="stylesheet" type="text/css" href="css/util.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <style>
        .custom-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            animation: fadeIn 0.3s;
        }
        
        .custom-modal-content {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            position: relative;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border: 2px solid #e9ecef;
        }

        .custom-modal-header {
            font-family: 'Poppins', sans-serif;
            font-size: 24px;
            color: #4a76a8;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 500;
            padding-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }

        .custom-modal-input {
            position: relative;
            margin-bottom: 25px;
        }

        .modal-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #adb5bd;
            z-index: 1;
            font-size: 20px;
        }

        .custom-modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 25px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translate(-50%, -40%); opacity: 0; }
            to { transform: translate(-50%, -50%); opacity: 1; }
        }

        /* Мобильная адаптация */
        @media (max-width: 480px) {
            .custom-modal-content {
                width: 95%;
                padding: 15px;
                border-radius: 8px;
            }
            
            .custom-modal-header {
                font-size: 20px;
                margin-bottom: 15px;
            }
            
            .custom-modal-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .login100-form-btn {
                width: 100%;
            }

            .modal-icon {
                left: 10px;
                font-size: 16px;
            }

            .input100.pl-40 {
                padding-left: 35px !important;
            }
        }

        .custom-modal-input input {
            font-size: 14px !important;
        }
    </style>
</head>
<body>
    <div class="limiter">
        <div class="container-login100" style="background-image: url('images/bg-01.jpg');">
            <div class="wrap-login100 p-l-55 p-r-55 p-t-65 p-b-54">
                <form class="login100-form validate-form">
                    <span class="login100-form-title p-b-49">Авторизация</span>
                
                    <div class="wrap-input100 validate-input m-b-23" data-validate="Email is required">
                        <span class="label-input100">Email</span>
                        <input class="input100" type="email" name="email" id="emailInput" placeholder="Введите ваш email">
                        <span class="focus-input100" data-symbol="&#xf206;"></span>
                    </div>
                
                    <div class="wrap-input100 validate-input" data-validate="Password is required">
                        <span class="label-input100">Пароль</span>
                        <input class="input100" type="password" name="pass" id="passwordInput" placeholder="Введите ваш пароль">
                        <span class="focus-input100" data-symbol="&#xf190;"></span>
                    </div>

                    <div class="text-right p-t-8 p-b-31">
                        <a href="#" id="forgotPassword" class="txt3">Забыли пароль?</a>
                    </div>
                    
                    <div class="container-login100-form-btn">
                        <div class="wrap-login100-form-btn">
                            <div class="login100-form-bgbtn"></div>
                            <button type="submit" class="login100-form-btn">Авторизоваться</button>
                        </div>
                    </div>

                    <div class="flex-c-m">
                        <a href="#" class="login100-social-item bg1">
                            <i class="fa fa-facebook"></i>
                        </a>
                        <a href="#" class="login100-social-item bg2">
                            <i class="fa fa-twitter"></i>
                        </a>
                        <a href="#" class="login100-social-item bg3">
                            <i class="fa fa-google"></i>
                        </a>
                    </div>

                    <div class="flex-col-c p-t-155">
                        <span class="txt1 p-b-17">Или зарегистрируйтесь с помощью</span>
                        <a href="#" class="txt2" id="registerLink">Зарегистрироваться</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Модальные окна -->
    <div class="custom-modal" id="customModal">
        <div class="custom-modal-content">
            <div class="custom-modal-header" id="modalTitle"></div>
            
            <div class="wrap-input100 validate-input custom-modal-input">
                <i class="zmdi zmdi-email modal-icon"></i>
                <input class="input100 pl-40" type="email" id="modalEmail" placeholder="Email">
            </div>

            <div class="wrap-input100 validate-input custom-modal-input" id="passwordField">
                <i class="zmdi zmdi-lock modal-icon"></i>
                <input class="input100 pl-40" type="password" id="modalPassword" placeholder="Пароль">
            </div>

            <div class="custom-modal-actions">
                <button class="login100-form-btn bg-secondary" id="modalCancel">Отмена</button>
                <button class="login100-form-btn bg-primary" id="modalConfirm">Продолжить</button>
            </div>
        </div>
    </div>

    <script src="vendor/jquery/jquery-3.2.1.min.js"></script>
    <script src="vendor/animsition/js/animsition.min.js"></script>
    <script src="vendor/bootstrap/js/popper.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.min.js"></script>
    <script src="vendor/select2/select2.min.js"></script>
    <script src="vendor/daterangepicker/moment.min.js"></script>
    <script src="vendor/daterangepicker/daterangepicker.js"></script>
    <script src="vendor/countdowntime/countdowntime.js"></script>
    <script src="js/main.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const API_BASE_URL = 'http://localhost:5000/api/auth';
            
            if (localStorage.getItem('authToken')) {
                window.location.href = 'profile.html';
            }

            const modal = {
                element: document.getElementById('customModal'),
                title: document.getElementById('modalTitle'),
                email: document.getElementById('modalEmail'),
                password: document.getElementById('modalPassword'),
                cancelBtn: document.getElementById('modalCancel'),
                confirmBtn: document.getElementById('modalConfirm')
            };

            let currentAction = null;

            function showModal(title, showPassword = true) {
                modal.title.textContent = title;
                document.getElementById('passwordField').style.display = showPassword ? 'block' : 'none';
                modal.element.style.display = 'block';
            }

            function hideModal() {
                modal.element.style.opacity = '0';
                setTimeout(() => {
                    modal.element.style.display = 'none';
                    modal.element.style.opacity = '1';
                    modal.email.value = '';
                    modal.password.value = '';
                }, 300);
            }

            modal.cancelBtn.addEventListener('click', hideModal);
            
            modal.confirmBtn.addEventListener('click', () => {
                if (currentAction === 'register') handleRegistration();
                else if (currentAction === 'forgot') handlePasswordRecovery();
            });

            document.getElementById('registerLink').addEventListener('click', (e) => {
                e.preventDefault();
                currentAction = 'register';
                showModal('Регистрация');
            });

            document.getElementById('forgotPassword').addEventListener('click', (e) => {
                e.preventDefault();
                currentAction = 'forgot';
                showModal('Восстановление пароля', false);
            });

            function validatePassword(password) {
                const re = /^(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()])[A-Za-z\d!@#$%^&*()]{6,}$/;
                return re.test(password);
            }

            async function handleRegistration() {
                const email = modal.email.value.trim();
                const password = modal.password.value.trim();

                if (!email || !password) {
                    showAlert('Заполните все поля');
                    return;
                }

                if (!validateEmail(email)) {
                    showAlert('Некорректный email');
                    return;
                }

                if (!validatePassword(password)) {
                    showAlert('Пароль должен содержать: 6+ символов, заглавную букву, цифру и спецсимвол');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });

                    const data = await response.json();
                    
                    if (!response.ok) throw new Error(data.message);
                    
                    showAlert('Регистрация успешна! Проверьте email', true);
                    hideModal();

                } catch (error) {
                    showAlert(error.message);
                }
            }

            document.querySelector('form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = e.target.email.value.trim();
                const password = e.target.pass.value.trim();

                if (!email || !password) {
                    showAlert('Заполните все поля');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });

                    const data = await response.json();
                    
                    if (!response.ok) throw new Error(data.message);
                    
                    localStorage.setItem('authToken', data.accessToken);
                    localStorage.setItem('refreshToken', data.refreshToken);
                    window.location.href = 'profile.html';

                } catch (error) {
                    showAlert(error.message);
                    e.target.reset();
                }
            });

            async function handlePasswordRecovery() {
                const email = modal.email.value.trim();

                if (!validateEmail(email)) {
                    showAlert('Некорректный email');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/forgot-password`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || 'Ошибка сервера');
                    }

                    showAlert('Инструкции по восстановлению отправлены на ваш email', true);
                    hideModal();

                } catch (error) {
                    showAlert(error.message || 'Ошибка при отправке запроса');
                }
            }

            function validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            }

            function showAlert(message, isSuccess = false) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'custom-modal';
                alertDiv.innerHTML = `
                    <div class="custom-modal-content" style="animation: slideIn 0.3s">
                        <div class="custom-modal-header">
                            <i class="fa ${isSuccess ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                            ${isSuccess ? 'Успешно!' : 'Ошибка'}
                        </div>
                        <div class="p-4 text-center">${message}</div>
                        <div class="custom-modal-actions">
                            <button class="login100-form-btn ${isSuccess ? 'bg-success' : 'bg-warning'}">
                                ${isSuccess ? 'Продолжить' : 'Понятно'}
                            </button>
                        </div>
                    </div>
                `;

                const btn = alertDiv.querySelector('button');
                btn.addEventListener('click', function() {
                    this.closest('.custom-modal').style.opacity = '0';
                    setTimeout(() => {
                        this.closest('.custom-modal').remove();
                        if (isSuccess) window.location.reload();
                    }, 300);
                });

                document.body.appendChild(alertDiv);
            }
        });
    </script>
</body>
</html>